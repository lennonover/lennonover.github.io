<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="前言现在创意 H5 做的堪比电影，传统方式的动画、gif 已经满足不了性能需求，越来越多的内容正在以 HTML5 视频的方式呈现，随之而来的视频优化变得的越来越重要。 HTML5 视频HTML5 视频是一种跨浏览器观看视频的方式，不需要类似 Flash 的插件，而且存储在 MP4 容器文件中的 H.264 编码视频已成为所有在线 HTML5 视频的标准格式。所以我们说的优化其实就是优化 MP4 格">
<meta property="og:type" content="article">
<meta property="og:title" content="视频优化">
<meta property="og:url" content="https://github.com/lennonover/2018/10/13/视频优化/index.html">
<meta property="og:site_name" content="lennonover">
<meta property="og:description" content="前言现在创意 H5 做的堪比电影，传统方式的动画、gif 已经满足不了性能需求，越来越多的内容正在以 HTML5 视频的方式呈现，随之而来的视频优化变得的越来越重要。 HTML5 视频HTML5 视频是一种跨浏览器观看视频的方式，不需要类似 Flash 的插件，而且存储在 MP4 容器文件中的 H.264 编码视频已成为所有在线 HTML5 视频的标准格式。所以我们说的优化其实就是优化 MP4 格">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="evernotecid://C7CEB9BA-7788-40AB-8ED8-6A27FD81C9B1/appyinxiangcom/11484604/ENResource/p375">
<meta property="og:image" content="evernotecid://C7CEB9BA-7788-40AB-8ED8-6A27FD81C9B1/appyinxiangcom/11484604/ENResource/p378">
<meta property="og:updated_time" content="2018-10-15T14:04:48.030Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="视频优化">
<meta name="twitter:description" content="前言现在创意 H5 做的堪比电影，传统方式的动画、gif 已经满足不了性能需求，越来越多的内容正在以 HTML5 视频的方式呈现，随之而来的视频优化变得的越来越重要。 HTML5 视频HTML5 视频是一种跨浏览器观看视频的方式，不需要类似 Flash 的插件，而且存储在 MP4 容器文件中的 H.264 编码视频已成为所有在线 HTML5 视频的标准格式。所以我们说的优化其实就是优化 MP4 格">
<meta name="twitter:image" content="evernotecid://C7CEB9BA-7788-40AB-8ED8-6A27FD81C9B1/appyinxiangcom/11484604/ENResource/p375">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/lennonover/2018/10/13/视频优化/"/>





  <title> 视频优化 | lennonover </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lennonover</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://github.com/lennonover/2018/10/13/视频优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lennonover">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lennonover">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                视频优化
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-13T18:04:00+08:00">
                2018-10-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><pre><code>现在创意 H5 做的堪比电影，传统方式的动画、gif 已经满足不了性能需求，越来越多的内容正在以 HTML5 视频的方式呈现，随之而来的视频优化变得的越来越重要。
</code></pre><h2 id="HTML5-视频"><a href="#HTML5-视频" class="headerlink" title="HTML5 视频"></a>HTML5 视频</h2><pre><code>HTML5 视频是一种跨浏览器观看视频的方式，不需要类似 Flash 的插件，而且存储在 MP4 容器文件中的 H.264 编码视频已成为所有在线 HTML5 视频的标准格式。所以我们说的优化其实就是优化 MP4 格式的视频。
一个 MP4 文件由很多个 box 组成的，用以存储字幕和章节等内容媒体信息。下面一些常见的 box：
</code></pre><p><img src="evernotecid://C7CEB9BA-7788-40AB-8ED8-6A27FD81C9B1/appyinxiangcom/11484604/ENResource/p375" alt="29a8063d9faae77b430c71a96f926d37.png"></p>
<h2 id="MP4"><a href="#MP4" class="headerlink" title="MP4"></a>MP4</h2><ul>
<li><p>生成<br>  先写入 mdat 后写入 moov，因此绝大多数工具都会把 moov 数据放到 mdat 后边，比如 mp4writer，ffmpeg 等工具 </p>
</li>
<li><p>解析<br>  解析播放的时候，先读取 moov，才能解析 mdat<br>播放影响</p>
</li>
<li><p>播放</p>
<ul>
<li>本地播放<br>播放软件可以任意位置，读取 moov</li>
<li>在线播放<ul>
<li>http 服务器不支持 seek（range requests 206 请求） 且 moov 后置<br>只能等到视频完全下载完成播放</li>
<li>http 服务器支持 seek<br>可以边下边播</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="moov"><a href="#moov" class="headerlink" title="moov"></a>moov</h2><pre><code>视频和音频原子的 box，以及有关如何播放视频的信息，如尺寸和每秒的帧数，则存储在叫做 moov 的特殊 box 中。你可以认为 moov box 是某种意义上的 MP4 文件目录。

当你播放视频时，程序会查找 MP4 文件，定位 moov box 的位置，然后借此去查找视频和音频的起始位置来开始播放。

box 可能以任意顺序排列，所以程序一开始并不知道 moov 原子在哪里。如果你已经拥有整个视频文件，查找 moov box 是完全没问题的(也就是本地播放)。但如果在线观看，也就是流传输 HTML5 视频时，就会有问题了，下面来看看 MP4 文件的 moov box 排列顺序是如何影响：

 读取 moov 的过程：直接发起 HTTP MP4 请求，读取响应 body 的开头，如果发现 moov 在开头，就接着往下读 mdat 。如果发现开头没有，先读到 mdat，立马 RESET 这个连接，节省流量，通过 Range 头读取文件末尾数据，因为前面一个 HTTP 请求已经获取到了 Content-Length ，知道了 MP4 文件的整个大小，通过 Range 头读取部分文件尾部数据也是可以读取到的。

  从上面可以看出当 moov 后置播放时浏览器会发送三次请求，对于在线播放，发送三个请求会比发送一个请求至少多耗几百毫秒。 
</code></pre> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">moov 后置</span><br><span class="line">├── ftyp</span><br><span class="line">├── free</span><br><span class="line">├── free</span><br><span class="line">├── mdat</span><br><span class="line">├── moov</span><br><span class="line">│   ├── mvhd</span><br><span class="line">│   ├── trak</span><br><span class="line">│   ├── trak</span><br><span class="line">│   ├── trak</span><br></pre></td></tr></table></figure>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><ul>
<li><p>Handbrake 优化<br><img src="evernotecid://C7CEB9BA-7788-40AB-8ED8-6A27FD81C9B1/appyinxiangcom/11484604/ENResource/p378" alt="a7f6a54c4a326c0409426ba3e6cb4947.png"></p>
</li>
<li><p>ffmpeg 优化</p>
<p>  <code>ffmpeg -i 你的视频.mp4 -movflags faststart -acodec copy -vcodec copy 输出的视频.mp4</code></p>
<p>  <code>movflags faststart</code> 参数告诉 ffmpeg 把 MP4 视频的 box 重新排序以使得 moov 位于开始位置。</p>
</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/17/硬件渲染了解一下/" rel="next" title="硬件渲染了解一下">
                <i class="fa fa-chevron-left"></i> 硬件渲染了解一下
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="lennonover" />
          <p class="site-author-name" itemprop="name">lennonover</p>
           
              <p class="site-description motion-element" itemprop="description">一丿口石砳磊</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTML5-视频"><span class="nav-number">2.</span> <span class="nav-text">HTML5 视频</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MP4"><span class="nav-number">3.</span> <span class="nav-text">MP4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#moov"><span class="nav-number">4.</span> <span class="nav-text">moov</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优化"><span class="nav-number">5.</span> <span class="nav-text">优化</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lennonover</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
