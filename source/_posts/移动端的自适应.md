---
title: 移动端的自适应
date: 2016-12-21 22:45:04
tags:
    - 移动端
    - 自适应
---

## 概念

- 完美视口
    
    在移动端，低端无定制的需求，都可以用这个完美视口完成。

- 物理像素(physical pixel)

    一个物理像素是显示器(手机屏幕)上最小的物理显示单元，在操作系统的调度下，每一个设备像素都有自己的颜色值和亮度值。


- 设备独立像素(density-independent pixel)

    设备独立像素(也叫密度无关像素)，可以认为是计算机坐标系统中得一个点，这个点代表一个可以由程序使用的虚拟像素(比如: css像素)，然后由相关系统转换为物理像素。同一张图片在各屏幕显示大小不一。
    我们希望不同屏幕显示图片的大小要一致。
    我们要计算图片缩放比例。
    
    计算公式：
    
    图片逻辑像素大小px1 / 图片缩放后实际像素大小px2 = 物理像素（设备像素dp） / 设备独立像素dips
    
    px2 = px1 * (dp / dips)
    
    px2 = px1 * dpr

- 设备像素比(device pixel ratio )

    设备像素比(简称dpr)定义了物理像素和设备独立像素的对应关系，它的值可以按如下的公式的得到
    
    设备像素比 = 物理像素 / 设备独立像素 

    在某一方向上，x方向或者y方向，可以通过window.devicePixelRatio获取到当前设备的dpr

    > 由于苹果retina的产生，使得清晰度提升，主要是因为`设备像素`提升了一倍，因此可以用更多像素去绘画更清晰的图像
    
    坊间对于dpr更通俗的说法叫

    - 一倍屏
    - 两倍屏
    - 三倍屏

- 屏幕拉伸比scale

    也就是视口上的initial-scale , maximum-sacle 等属性

    > scale 和 dpr的关系是倒数。

- 例子

    以iphone6为例：

    设备宽高为375×667，可以理解为设备独立像素(或css像素)。
    dpr为2，根据上面的计算公式，其物理像素就应该×2，为750×1334。

    在不同的屏幕上(普通屏幕 vs retina屏幕)，css像素所呈现的大小(物理尺寸)是一致的，不同的是1个css像素所对应的物理像素个数是不一致的。

    在普通屏幕下，1个css像素 对应 1个物理像素(1:1)。 在retina 屏幕下，1个css像素对应 4个物理像素(1:4)。

- 位图像素

    一个位图像素是栅格图像(如：png, jpg, gif等)最小的数据单元。每一个位图像素都包含着一些自身的显示信息(如：显示位置，颜色值，透明度等)。

    理论上，1个位图像素对应于1个物理像素，图片才能得到完美清晰的展示。

    在普通屏幕下是没有问题的，但是在retina屏幕下就会出现位图像素点不够，从而导致图片模糊的情况。

    

    对于dpr=2的retina屏幕而言，1个位图像素对应于4个物理像素，由于单个位图像素不可以再进一步分割，所以只能就近取色，从而导致图片模糊(注意上述的几个颜色值)。

    所以，对于图片高清问题，比较好的方案就是两倍图片(@2x)。

    如：200×300(css pixel)img标签，就需要提供400×600的图片。

    如此一来，位图像素点个数就是原来的4倍，在retina屏幕下，位图像素点个数就可以跟物理像素点个数形成 1 : 1的比例，图片自然就清晰了(这也解释了之前留下的一个问题，为啥视觉稿的画布大小要×2？)。

    在普通屏幕下，200×300(css pixel)img标签，所对应的物理像素个数就是200×300个，而两倍图片的位图像素个数则是200×300*4，所以就出现一个物理像素点对应4个位图像素点，所以它的取色也只能通过一定的算法(显示结果就是一张只有原图像素总数四分之一，我们称这个过程叫做downsampling)，肉眼看上去虽然图片不会模糊，但是会觉得图片缺少一些锐利度，或者是有点色差(但还是可以接受的)。

## 移动端的问题

- retina屏幕，图片高清问题
    
    两倍图片(@2x)，然后图片容器缩小50%。
    
    
``` css

    img标签
    width: 200px;
    height: 300px;
    背景图片
    width: 200px;
    height: 300px;
    background-image: url(image@2x.jpg);
    background-size: 200px 300px;

```
缺点普通屏幕下：

同样下载了@2x的图片，造成资源浪费。
图片由于downsampling，会失去了一些锐利度(或是色差)。

解决办法是：不同的dpr下，加载不同的尺寸的图片。

这样的话，是不是是要准备两套图片了？

解决；用图片服务器，通过url获取参数，然后可以控制图片质量，也可以将图片裁剪成不同的尺寸。

- retina下，border: 1px问题

    设计师想要的retina下border: 1px;，其实就是1物理像素宽，对于css而言，可以认为是border: 0.5px;，这是retina下(dpr=2)下能显示的最小单位。

    并不是所有手机浏览器都能识别border: 0.5px;，ios7以下，android等其他系统里，0.5px会被当成为0px处理，那么如何实现这0.5px呢
    
    最简单的一个做法就是这样(元素scale)：
``` CSS
.scale{
    position: relative;
}
.scale:after{
    content:"";
    position: absolute;
    bottom:0px;
    left:0px;
    right:0px;
    border-bottom:1px solid #ddd;
    -webkit-transform:scaleY(.5);
    -webkit-transform-origin:0 0;
}

```
但是这样hack实在是不够通用(如：圆角等)，写起来也麻烦。

比较推荐的还是页面scale的方案，是比较通用的，几乎满足所有场景。

对于iphone5(dpr=2)，添加如下的meta标签，设置viewport(scale 0.5)

```HTML
<meta name="viewport" content="width=640,initial-scale=0.5,maximum-scale=0.5, minimum-scale=0.5,user-scalable=no">
```

- 多屏适配布局问题

    
    基于rem的原理,针对不同手机屏幕尺寸和dpr动态的改变根节点html的font-size大小(基准值)。
    乘以dpr，是因为页面有可能为了实现1px border页面会缩放(scale) 1/dpr 倍(如果没有，dpr=1),。
除以10，是为了取整，方便计算(理论上可以是任何值)

    ```
    rem = document.documentElement.clientWidth * dpr / 10
    ```

    - CSS方式更改
    
    通过设备宽度来媒体查询来改变html的font-size：

    - javascript方式更改

    通过上面的公式，计算出基准值rem，然后写入样式

- 字体大小问题

    设置viewpor页面scale，必然会带来字体大小会被缩放。

    针对不同的分辨率(dpr不同)，设置不用的大小。

## 各大厂解决方案

- 手机淘宝

    - 获取手机dpr(window.devicePixelRatio)，动态生成viewport。
    - 换取手机宽度，分成10份，每一份的宽度即是rem的尺寸。
    - 根据设计稿尺寸(px)通过计算，转换成rem去布局。

- 天猫

    - 采用scale=1.0 写死viewport。
    - flex布局，笃定认为布局尺寸是375 (iPhone6)
    - rem 确定非flex的元素

- 手机携程

    - 采用scale=1.0 写死viewport
    - px + 百分比布局

- 拉钩

    - 关键元素高宽和位置都不变，只有容器元素在做伸缩变换。
    - 文字流式，控件弹性，图片等比缩放

## 如何与设计协作

1. 视觉设计阶段，设计师按宽度750px（iPhone 6）做设计稿，除图片外所有设计元素用矢量路径来做。设计定稿后在750px的设计稿上做标注，输出标注图。同时等比放大1.5倍生成宽度1125px的设计稿，在1125px的稿子里切图。

2. 输出两个交付物给开发工程师：一个是程序用到的@3x切图资源，另一个是宽度750px的设计标注图。

3. 开发工程师拿到750px标注图和@3x切图资源，完成iPhone 6（375pt）的界面开发。此阶段不能用固定宽度的方式开发界面，得用自动布局（auto layout），方便后续适配到其它尺寸。

4. 适配调试阶段，基于iPhone 6的界面效果，分别向上向下调试iPhone 6 plus（414pt）和iPhone 5S及以下（320pt）的界面效果。由此完成大中小三屏适配。

## 鞠躬








